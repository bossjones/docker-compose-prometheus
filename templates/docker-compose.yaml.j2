version: '3.8'

networks:
  loki:

# Since only root has access to /var/lib/docker and I'm running the Grafana agent under its own user on the host itself, changing the permissions to that directory seemed like a bad idea to me. After a bit of research I figured out how to make this work using the journald driver, which works nicely.
# SOURCE: https://gist.github.com/ruanbekker/c6fa9bc6882e6f324b4319c5e3622460?permalink_comment_id=4009155#gistcomment-4009155
{% raw %}
x-logging:
  &default-logging
  driver: "journald"
  options:
    tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"

# for the unifipoller bits
# https://github.com/unpoller/unpoller/blob/master/init/docker/docker-compose.yml
volumes:
    prometheus_data: {}
    grafana_data: {}
    netdataconfig:
    netdatalib:
    netdatacache:
    influxdb-storage:
    chronograf-storage:
    grafana-storage:
    alertmanager-data:
    loki:
    pihole_etc:
    pihole_dnsmasq:
{% endraw %}

services:
{% if traefik_feature_flag %}
  # SOURCE: https://doc.traefik.io/traefik/user-guides/docker-compose/basic-example/
  # SOURCE: https://doc.traefik.io/traefik/user-guides/docker-compose/basic-example/
  traefik:
    image: "traefik:v2.10.4"
    container_name: "traefik"
    # environment:
    # # SOURCE: https://community.traefik.io/t/docker-compose-static-config-issue/10987
    command:
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:89"
      - "--entrypoints.traefik.address=:8989"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addrouterslabels=true"
      - "--api=true"
      - "--api.insecure=true"
      - "--providers.docker.network=loki"
      - "--ping=true"
      - "--ping.entrypoint=traefik"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.filename=/etc/traefik/dynamic/dynamic.yaml"
      - "--providers.file.watch=true"
    ports:
      - "8900:89"
      - "8989:8989"
      - "8082:8082"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - ./traefik/traefik.yaml:/etc/traefik/traefik.yaml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.entrypoints=web"
      - "traefik.http.services.traefik.loadbalancer.server.port=8989"
      - "traefik.docker.network=loki"
    networks:
      loki: null
    # - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}
{% endif %}

  loki-gateway:
    image: nginx:1.19
    container_name: "loki-gateway"
    depends_on:
      - 'loki-read'
      - 'loki-write'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "8080:80"
      - "3100:3100"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.loki-gateway-http.rule=Host(`loki-gateway.localhost`)"
      - "traefik.http.routers.loki-gateway-http.entrypoints=web"
      - "traefik.http.routers.loki-gateway-http.service=loki-gateway-http-service"
      - "traefik.http.services.loki-gateway-http-service.loadbalancer.server.port=80"
    networks:
      - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

  # Since the Loki containers are running as user 10001 and the mounted data volume is owned by root,
  # Loki would not have permissions to create the directories.
  # Therefore the init container changes permissions of the mounted directory.
  init:
    image: grafana/loki:2.8.3
    user: root
    entrypoint:
      - "chown"
      # - "10001:10001"
      - "1000:1000"
      - "/loki"
    volumes:
      - ./loki:/loki
    networks:
      - loki

  minio:
    image: minio/minio:RELEASE.2023-06-29T05-12-28Z
    container_name: minio
    entrypoint:
      - sh
      - -euc
      - |
        mkdir -p /data/loki-data && \
        mkdir -p /data/loki-ruler &&
        minio server /data --address ":9000" --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=loki
      - MINIO_ROOT_PASSWORD=supersecret
      - MINIO_PROMETHEUS_AUTH_TYPE=public
      - MINIO_UPDATE=off
      - MINIO_PROMETHEUS_URL=http://prometheus:9090
      - MINIO_PROMETHEUS_JOB_ID=minio-cluster
      - MINIO_BROWSER=on
      # - MINIO_ACCESS_KEY=admin
      # - MINIO_SECRET_KEY=password
    ports:
      - "9000:9000"
      - "9001:9001"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio-http.rule=Host(`minio.localhost`)"
      - "traefik.http.routers.minio-http.entrypoints=web"
      - "traefik.http.routers.minio-http.service=minio-http-service"
      - "traefik.http.services.minio-http-service.loadbalancer.server.port=9000"
    volumes:
      - ./.data/minio:/data
    networks:
      - loki

{% if log_generator_feature_flag %}
  # for testing purposes only, disable in production
  log-generator:
    image: mingrammer/flog
    command:
      - --loop
      - --format=json
      - --number=10 # number of log lines to generate per second
      - --delay=100ms # delay between log lines
      - --output=/var/log/generated-logs.txt
      - --overwrite
      - --type=log
    volumes:
      - ./loki/:/var/log/
{% endif %}

  whoami:
    image: "traefik/whoami:v1.8.0"
    container_name: "whoami"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami.rule=Host(`whoami.{{ fqdn }}`)"
      - "traefik.http.routers.whoami.entrypoints=web"
      - "traefik.http.services.whoami.loadbalancer.server.port=10080"
    expose:
      - 10080
    environment:
    #- TZ=UTC
    - WHOAMI_PORT_NUMBER=10080
    - WHOAMI_NAME=whoami
    ports:
    - 10080:10080
    networks:
    - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

{% if pihole_feature_flag %}
  pihole:
    image: "pihole/pihole:latest"
    # For DHCP it is recommended to remove these ports and instead add: network_mode: "host"
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      # - "67:67/udp" # Only required if you are using Pi-hole as your DHCP server
      - "81:80/tcp"
    container_name: pihole
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pihole.rule=Host(`pihole.{{ fqdn }}`)"
      - "traefik.http.routers.pihole.entrypoints=web"
      - "traefik.http.services.pihole.loadbalancer.server.port=80"
    # Volumes store your data between container upgrades
    expose:
    - 81
    volumes:
      - 'pihole_etc:/etc/pihole'
      - 'pihole_dnsmasq:/etc/dnsmasq.d'
    #   https://github.com/pi-hole/docker-pi-hole#note-on-capabilities
    cap_add:
      - NET_ADMIN # Required if you are using Pi-hole as your DHCP server, else not needed
    restart: unless-stopped
    environment:
    - TZ=America/New_York
    - WEBPASSWORD=raspberry
    # Use the Pi-hole web UI to change the DNS settings Interface listening behavior to "Listen on all interfaces, permit all origins", if using Docker's default bridge network setting. (This can also be achieved by setting the environment variable DNSMASQ_LISTENING to all)
    - DNSMASQ_LISTENING=all
    - PIHOLE_DNS_=127.0.0.1;1.1.1.1;1.0.0.1
    - NETWORK_ACCESS=internal
    - VIRTUAL_HOST=pi.hole
    - PROXY_LOCATION=pi.hole
    # Set to your server's LAN IP, used by web block modes.
    - FTLCONF_LOCAL_IPV4={{ prometheus_server_ip }}
    # - LOCAL_IPV4={{ prometheus_server_ip }}
    - WEBLOGS_STDOUT=1
    - DHCP_ACTIVE=false
    - DNSSEC=true
    dns:
      - "127.0.0.1"
      - "1.1.1.1"
      - "1.0.0.1"
    networks:
    - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}
  pihole-exporter:
    image: "ekofr/pihole-exporter:latest"
    # For DHCP it is recommended to remove these ports and instead add: network_mode: "host"
    hostname: 'pihole-exporter'
    ports:
      - "9617:9617/tcp"
    container_name: pihole-exporter
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pihole-exporter.rule=Host(`pihole-exporter.{{ fqdn }}`)"
      - "traefik.http.routers.pihole-exporter.entrypoints=web"
      - "traefik.http.services.pihole-exporter.loadbalancer.server.port=9617"
    # Volumes store your data between container upgrades
    expose:
    - 9617
    restart: unless-stopped
    environment:
    - TZ=America/New_York
    - PORT=9617
    - PIHOLE_PASSWORD=raspberry
    - PIHOLE_HOSTNAME=pihole
    - PIHOLE_PORT=80
    networks:
    - loki
    depends_on:
      - pihole
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}
{% endif %}

  influxdb:
    restart: always
    image: influxdb:1.8
    container_name: influxdb
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.influxdb.rule=Host(`influxdb.{{ fqdn }}`)"
    - "traefik.http.routers.influxdb.entrypoints=web"
    - "traefik.http.services.influxdb.loadbalancer.server.port=8086"
    ports:
      - '8086:8086'
    volumes:
      - influxdb-storage:/var/lib/influxdb
    environment:
      - INFLUXDB_DB=${INFLUXDB_DB}
      - INFLUXDB_HTTP_AUTH_ENABLED=${INFLUXDB_HTTP_AUTH_ENABLED}
      - INFLUXDB_ADMIN_USER=${INFLUXDB_ADMIN_USER}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      # SOURCE: https://docs.influxdata.com/influxdb/v1.8/administration/config/
      - INFLUXDB_META_LOGGING_ENABLED=1
      - INFLUXDB_HTTP_ENABLED=1
      - INFLUXDB_HTTP_LOG_ENABLED=1
      # - INFLUXDB_HTTP_AUTH_ENABLED=0
      - INFLUXDB_LOGGING_LEVEL={{ influxdb_log_level }}
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_ADMIN_TOKEN}
      # CREATE DATABASE unifi
      # USE unifi
      # CREATE USER unifipoller WITH PASSWORD 'unifipoller' WITH ALL PRIVILEGES
      # GRANT ALL ON unifi TO unifipoller
      # exit
      # DOCKER_INFLUXDB_INIT_USERNAME: The username to set for the system's initial super-user (Required).
      # DOCKER_INFLUXDB_INIT_PASSWORD: The password to set for the system's inital super-user (Required).
      # DOCKER_INFLUXDB_INIT_ORG: The name to set for the system's initial organization (Required).
      # DOCKER_INFLUXDB_INIT_BUCKET: The name to set for the system's initial bucket (Required).
      # DOCKER_INFLUXDB_INIT_RETENTION: The duration the system's initial bucket should retain data. If not set, the initial bucket will retain data forever.
      # DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: The authentication token to associate with the system's initial super-user. If not set, a token will be auto-generated by the system.
      # - DOCKER_INFLUXDB_INIT_MODE=setup
      # - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_ADMIN_USER}
      # - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      # - DOCKER_INFLUXDB_INIT_ORG=unpoller
      # - DOCKER_INFLUXDB_INIT_BUCKET=unpoller
      # - DOCKER_INFLUXDB_INIT_RETENTION=1w
      # - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=unpollersecret
      #- TZ=UTC
    env_file:
      - ./env
    networks:
    - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

  chronograf:
    restart: always
    image: chronograf:latest
    container_name: chronograf
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.chronograf.rule=Host(`chronograf.{{ fqdn }}`)"
    - "traefik.http.routers.chronograf.entrypoints=web"
    - "traefik.http.services.chronograf.loadbalancer.server.port=8888"
    ports:
      - '8888:8888'
    volumes:
      - chronograf-storage:/var/lib/chronograf
    depends_on:
      - influxdb
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      # - INFLUXDB_URL=${INFLUXDB_URL}
      - INFLUXDB_USERNAME=${INFLUXDB_ADMIN_USER}
      - INFLUXDB_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
      #- TZ=UTC
    env_file:
      - ./env
    networks:
    - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

  # docker pull prom/prometheus:v2.31.1
  prometheus:
    image: prom/prometheus:v2.31.1
    container_name: prometheus
    # labels:
    # - "traefik.enable=true"
    # - "traefik.http.routers.prometheus.rule=Host(`prometheus.{{ fqdn }}`)"
    # - "traefik.http.routers.prometheus.entrypoints=web"
    # - "traefik.http.services.prometheus.loadbalancer.server.port=9090"
    expose:
    - 9090
    tty: true
    stdin_open: true
    volumes:
      - ./prometheus/:/etc/prometheus/
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.listen-address=0.0.0.0:9090'
      - '--log.level={{ prometheus_log_level }}'
      - '--enable-feature=remote-write-receiver'
      - '--query.lookback-delta=30s'
    ports:
      - 9092:9090
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus-http.rule=Host(`prometheus.localhost`)"
      - "traefik.http.routers.prometheus-http.entrypoints=web"
      - "traefik.http.routers.prometheus-http.service=prometheus-http-service"
      - "traefik.http.services.prometheus-http-service.loadbalancer.server.port=9090"
    links:
{% if cadvisor_feature_flag %}
      - cadvisor:cadvisor
{% endif %}
      - alertmanager:alertmanager
      - loki-gateway:loki-gateway
      - pihole-exporter:pihole-exporter
    depends_on:
{% if cadvisor_feature_flag %}
      - cadvisor
{% endif %}
      - alertmanager
      - loki-gateway
      - pihole-exporter
    restart: always

    # environment:
    #- TZ=UTC
    # SEE: https://stackoverflow.com/questions/31324981/how-to-access-host-port-from-docker-container/43541732#43541732
    # https://stackoverflow.com/questions/56909896/prometheus-in-docker-container-cannot-scrape-target-on-host/56910057
    networks:
    - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.node-exporter.rule=Host(`node-exporter.{{ fqdn }}`)"
    - "traefik.http.routers.node-exporter.entrypoints=web"
    - "traefik.http.services.node-exporter.loadbalancer.server.port=9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      # - --collector.filesystem.ignored-mount-points
      # - "^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)"
      -  '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
      # - '--collector.thermal_zone-exclude'
    expose:
    - 9100
    ports:
      - 9100:9100
    restart: always
    deploy:
      mode: global
    # environment:
    #- TZ=UTC
    networks:
    - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

  alertmanager:
    image: prom/alertmanager
    container_name: alertmanager
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.alertmanager.rule=Host(`alertmanager.{{ fqdn }}`)"
    - "traefik.http.routers.alertmanager.entrypoints=web"
    - "traefik.http.services.prometheus.loadbalancer.server.port=9093"
    tty: true
    stdin_open: true
    expose:
    - 9093
    ports:
      - 9093:9093
    volumes:
      - ./alertmanager/:/etc/alertmanager/
      - alertmanager-data:/data
    restart: always
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
      - '--log.level={{ alertmanager_log_level }}'
    # environment:
    #- TZ=UTC
    networks:
    - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

{% if cadvisor_feature_flag %}
  cadvisor:
    # SOURCE: https://github.com/rafaribe/home-ops/blob/d9e283fd3ddc42a9891c8a12fe82fa128657798a/provision/ansible/backup-server/roles/syncthing/templates/agent.yml
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: cadvisor
    privileged: true
    userns_mode: "host"
    pid: "host"
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.cadvisor.rule=Host(`cadvisor.{{ fqdn }}`)"
    - "traefik.http.routers.cadvisor.entrypoints=web"
    - "traefik.http.services.cadvisor.loadbalancer.server.port=8081"
    volumes:
        - /:/rootfs:ro
        - /var/run:/var/run:ro
        - /sys:/sys:ro
        - /var/lib/docker/:/var/lib/docker:ro
        - /dev/disk/:/dev/disk:ro
        - /etc/machine-id/:/etc/machine-id:ro
    devices:
        - /dev/kmsg:/dev/kmsg:ro
    ports:
        - "8081:8081"
    expose:
      - 8081
    restart: always
    entrypoint:
      - /usr/bin/cadvisor
      # - --v=6
      - '--max_procs=2'
      - '--listen_ip=0.0.0.0'
      - '--port=8081'
      - '--logtostderr'
      # - '--enable_load_reader=true'
      - '--machine_id_file="/etc/machine-id"'
      - '--enable_metrics=advtcp,app,cpu,cpu_topology,cpuset,disk,diskIO,hugetlb,memory,memory_numa,network,oom_event,percpu,perf_event,process,resctrl,sched,tcp,udp'
      - '--disable_metrics=referenced_memory,cpuLoad'
      # - "--housekeeping_interval=30s"
      # - "--max_housekeeping_interval=35s"
      # - "--event_storage_event_limit=default=0"
      # - "--event_storage_age_limit=default=0"
      # - "--store_container_labels=false"
      # - "--whitelisted_container_labels=io.kubernetes.container.name,io.kubernetes.pod.name,io.kubernetes.pod.namespace,io.kubernetes.pod.uid"
      # - "--global_housekeeping_interval=30s"
      # - "--event_storage_event_limit=default=0"
      # - "--event_storage_age_limit=default=0"
      # - "--disable_metrics=percpu,process,sched,tcp,udp,diskIO,disk,network"
      # - "--allow_dynamic_housekeeping=true"
      # - "--storage_duration=1m0s"
    env_file:
      - ./env
    # devices:
    # - /dev/kmsg:/dev/kmsg
    # environment:
    #- TZ=UTC
    networks:
    - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}
{% endif %}

  blackbox:
    image: prom/blackbox-exporter
    privileged: true
    container_name: blackbox
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.blackbox.rule=Host(`blackbox.{{ fqdn }}`)"
    - "traefik.http.routers.blackbox.entrypoints=web"
    - "traefik.http.services.blackbox.loadbalancer.server.port=9115"
    tty: true
    stdin_open: true
    ports:
    - "9115:9115/tcp"
    - "9115:9115/udp"
    expose:
    - 9115
    volumes:
    - ./blackbox/config:/config
    command:
      - '--config.file=/config/blackbox.yml'
      - '--web.listen-address=:9115'

    restart: always
    deploy:
      mode: global
    #environment:
    #- TZ=UTC
    networks:
    - loki
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

#   heimdall:
#     image: linuxserver/heimdall
#     build: ./docker-heimdall
#     container_name: heimdall
#     restart: always
#     environment:
#       - PUID=1000
#       - PGID=1000
#       #- TZ=UTC
#     volumes:
#       - ./docker-heimdall/config:/config
#     ports:
#       - 4040:4040
#       - 4443:4443
#     labels:
#     - "traefik.enable=true"
#     - "traefik.http.routers.heimdall.rule=Host(`heimdall.{{ fqdn }}`)"
#     - "traefik.http.routers.heimdall.entrypoints=web"
#     - "traefik.http.services.heimdall.loadbalancer.server.port=4040"
#     tty: true
#     stdin_open: true
#     expose:
#     - 4040
#     - 4443
#     networks:
#     - loki
{% raw %}
#     logging:
#       driver: json-file
#       options:
#         tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}


  unifi-poller:
    restart: always
    # 2023: Use -> ghcr.io/unpoller/unpoller:${POLLER_TAG}
    image: golift/unifi-poller:${POLLER_TAG}
    ports:
      - "9130:9130/tcp"
      - "9130:9130/udp"
      - "37288:37288"
    expose:
    - 9130
    container_name: unifi-poller
    tty: true
    stdin_open: true
    volumes:
      - ./unpoller/up.conf:/etc/unpoller/up.conf
    env_file:
      - ./env
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.unifipoller.rule=Host(`unifi-poller.{{ fqdn }}`)"
    - "traefik.http.routers.unifipoller.entrypoints=web"
    - "traefik.http.services.unifipoller.loadbalancer.server.port=37288"
    depends_on:
      - grafana
      - influxdb
      - chronograf
    environment:
    - UP_WEBSERVER_ENABLE=true
    - UP_INFLUXDB_DB=${INFLUXDB_DB}
    - UP_INFLUXDB_USER=${INFLUXDB_ADMIN_USER}
    - UP_INFLUXDB_PASS=${INFLUXDB_ADMIN_PASSWORD}
    - UP_INFLUXDB_ORG=${INFLUXDB_ORG}
    - UP_INFLUXDB_BUCKET=${INFLUXDB_BUCKET}
    - UP_INFLUXDB_AUTH_TOKEN=${INFLUXDB_ADMIN_TOKEN}
    - UP_INFLUXDB_URL=http://influxdb:8086
    - UP_UNIFI_DEFAULT_USER=${UNIFI_USER}
    - UP_UNIFI_DEFAULT_PASS=${UNIFI_PASS}
    - UP_UNIFI_DEFAULT_URL=${UNIFI_URL}
    - UP_POLLER_DEBUG=${POLLER_DEBUG}
    - UP_UNIFI_DEFAULT_SAVE_DPI=${POLLER_SAVE_DPI}
    - UP_PROMETHEUS_NAMESPACE=unifipoller
    networks:
    - loki


  loki-read:
    user: "1000"
    image: grafana/loki:2.8.3
    volumes:
      # - ./config:/etc/loki/
      # - ./loki/etc/loki:/etc/loki/
      - ./loki/etc/loki:/loki:rw
      - ./rules:/loki/rules:ro
    ports:
      # - 3101:3100
      # - 7946
      - "9095"
      #- "3101:3100"
      - "3100"
      - "7946"
      # uncomment to use interactive debugging
      # - "40000-40002:40000" # # makes the replicas available on ports 40000, 40001, 40002
    #cap_add:
    #  - SYS_PTRACE
    #security_opt:
    #  - apparmor=unconfined
    command: "-config.file=/loki/loki-config.yaml -log.level={{ loki_log_level }} -target=read -legacy-read-mode=false"
    env_file:
      - ./env
    networks:
      - loki
    depends_on:
      - minio
    restart: always
    deploy:
      mode: replicated
      replicas: 3
    # only needed for interactive debugging with dlv
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

  loki-write:
    user: "1000"
    image: grafana/loki:2.8.3
    volumes:
      # - ./config:/etc/loki/
      - ./loki/etc/loki:/loki:rw
    ports:
      - "9095"
      #- "3102:3100"
      - "3100"
      - "7946"
      # uncomment to use interactive debugging
      # - "50000-50002:40000" # makes the replicas available on ports 50000, 50001, 50002
    #cap_add:
    #  - SYS_PTRACE
    #security_opt:
    #  - apparmor=unconfined
    # command: "-config.file=/loki/loki-config.yaml -log.level={{ loki_log_level }} -target=write -frontend.downstream-url=http://loki-gateway:3100 -querier.frontend-address=http://loki-write:9095"
    command: "-config.file=/loki/loki-config.yaml -log.level={{ loki_log_level }} -target=write -frontend.downstream-url=http://loki-gateway"
    env_file:
      - ./env
    networks:
      - loki
    depends_on:
      - minio
    restart: always
    deploy:
      mode: replicated
      replicas: 3
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

  loki-backend:
    user: "1000"
    image: grafana/loki:2.8.3
    volumes:
      # - ./config:/etc/loki/
      - ./loki/etc/loki:/loki:rw
    ports:
      - "9095"
      #- "3102:3100"
      - "3100"
      - "7946"
      # uncomment to use interactive debugging
      # - "50000-50002:40000" # makes the replicas available on ports 50000, 50001, 50002
    #cap_add:
    #  - SYS_PTRACE
    #security_opt:
    #  - apparmor=unconfined
    # command: "-config.file=/loki/loki-config.yaml -log.level={{ loki_log_level }} -target=write -frontend.downstream-url=http://loki-gateway:3100 -querier.frontend-address=http://loki-write:9095"
    command: "-config.file=/loki/loki-config.yaml -log.level={{ loki_log_level }} -target=backend -legacy-read-mode=false"
    env_file:
      - ./env
    networks:
      - loki
    depends_on:
      - minio
    restart: always
    deploy:
      mode: replicated
      replicas: 3
{% raw %}
    logging:
      driver: json-file
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}

#   loki:
#     restart: always
#     image: grafana/loki:2.8.3
#     ports:
#       - "3100:3100/tcp"
#       - "9096:9096"
#     container_name: loki
#     tty: true
#     stdin_open: true
#     env_file:
#       - ./env
#     volumes:
#     - ./loki/etc/loki:/loki
#     labels:
#     - "traefik.enable=true"
#     - "traefik.http.routers.loki.rule=Host(`loki.{{ fqdn }}`)"
#     - "traefik.http.routers.loki.entrypoints=web"
#     - "traefik.http.services.loki.loadbalancer.server.port=3100"
#     command: -config.file=/loki/loki-config.yaml
#     networks:
#     - loki
{% raw %}
#     logging:
#       driver: json-file
#       options:
#         tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"
{% endraw %}


  promtail:
    # SOURCE: https://github.com/gilmrt/docker-compose/blob/5d8d7b3746fba48ba5f559f9913e56ae3d881eee/metrics/docker-compose.yml
    container_name: promtail
    image: grafana/promtail:2.8.3
    restart: always
    depends_on:
      - 'loki-gateway'
      - 'loki-read'
      - 'loki-write'
      - 'loki-backend'
    volumes:
      # - /var/log:/var/log:ro
      - ./promtail/promtail-gateway.yaml:/etc/promtail/promtail-gateway.yaml:ro
      # - ./promtail/promtail-debug.yaml:/etc/promtail/promtail-debug.yaml:rw
      # - /var/log/journal/:/var/log/journal/:ro
      # - /run/log/journal/:/run/log/journal/:ro
      - /etc/machine-id:/etc/machine-id:ro
      - ./promtail/var/run/promtail:/var/run/promtail
      # to read container labels and logs
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      # - /var/lib/docker/containers:/var/lib/docker/containers:ro
      # - /home/pi/dev/bossjones/elk-docker/rsyslog-conf/log:/log
      # so we can get generated logs
      - ./loki/:/var/log/:ro
    ports:
      - "9080:9080"
    expose:
    - 9080
    command:
    - '-config.file=/etc/promtail/promtail-gateway.yaml'
    # - '-print-config-stderr'
    # - '-log-config-reverse-order'
    - '--inspect'
    # environment:
    #- TZ=UTC
    tty: true
    stdin_open: true
    env_file:
      - ./env
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.promtail.rule=Host(`promtail.{{ fqdn }}`)"
    - "traefik.http.routers.promtail.entrypoints=web"
    - "traefik.http.services.promtail.loadbalancer.server.port=9080"
    # depends_on:
    # - loki
    networks:
    - loki

  grafana:
    image: grafana/grafana:10.0.1
    container_name: grafana
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.grafana.rule=Host(`grafana.{{ fqdn }}`)"
    - "traefik.http.routers.grafana.entrypoints=web"
    - "traefik.http.services.grafana.loadbalancer.server.port=3000"
    depends_on:
      - prometheus
      - loki-gateway
    links:
      - prometheus:prometheus
      - loki-gateway:loki-gateway
      - alertmanager:alertmanager
      - influxdb:influxdb
    expose:
    - 3000
    ports:
      - 3000:3000
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/etc/grafana/grafana.ini:/etc/grafana/grafana.ini
      - ./grafana/provisioning/:/etc/grafana/provisioning/
    env_file:
      - ./env
    restart: always
    # entrypoint:
    #   - sh
    #   - -euc
    #   - |
    #     mkdir -p /etc/grafana/provisioning/datasources
    #     cat <<EOF > /etc/grafana/provisioning/datasources/ds.yaml
    #     apiVersion: 1
    #     datasources:
    #     - name: Loki
    #       type: loki
    #       access: proxy
    #       orgId: 1
    #       url: http://loki:3100
    #       basicAuth: false
    #       isDefault: true
    #       version: 1
    #       editable: false
    #     EOF
    #     /run.sh
    environment:
    #- TZ=UTC
    - GF_INSTALL_PLUGINS=grafana-clock-panel,natel-discrete-panel,grafana-piechart-panel
    - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
    - GF_AUTH_ANONYMOUS_ENABLED=true
    - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    - GF_DATAPROXY_TIMEOUT=310
    - GF_LOG_LEVEL={{ grafana_log_level }}
    - GF_DATAPROXY_LOGGING=true
    - GF_EXPLORE_ENABLED=true
    - GF_PATHS_CONFIG=/etc/grafana/grafana.ini
    networks:
    - loki

  # https://github.com/lux4rd0/grafana-loki-syslog-aio/blob/main/docker-compose-with-generator.yml
  syslog-ng:
    image: balabit/syslog-ng:latest
    container_name: syslog-ng
    command: -edv --control /syslog-ng/syslog-ng.ctl
    depends_on:
    - promtail
    networks:
      loki: null
    ports:
    - protocol: udp
      published: 514
      target: 514
    - protocol: tcp
      published: 601
      target: 601
    restart: always
    volumes:
    - ./syslog-ng/syslog-ng.conf:/etc/syslog-ng/syslog-ng.conf:ro
    - ./syslog-ng:/syslog-ng:rw

{% if syslog_ng_exporter_feature_flag %}
  syslog_ng_exporter:
    # build:
    #   context: ./syslog_ng_exporter
    image: brandond/syslog_ng_exporter:latest
    container_name: syslog_ng_exporter
    command:
    - '--telemetry.address=:9577'
    - '--telemetry.endpoint=/metrics'
    - '--socket.path=/syslog-ng/syslog-ng.ctl'
    # - '--log.level=info'
    depends_on:
    - syslog-ng
    networks:
      loki: null
    ports:
    - protocol: tcp
      published: 9577
      target: 9577
    restart: always
    volumes:
    - ./syslog-ng:/syslog-ng:rw
{% endif %}

{% if log_generator_feature_flag %}
  syslog-generator:
    build:
      context: ./syslog-generator
    container_name: syslog-generator
    depends_on:
    - syslog-ng
    networks:
      loki: null
{% endif %}
